PARTITION BY — это ключевая конструкция в `оконных функциях (window functions)` ,  которая позволяет выполнять вычисления по подмножествам строк в таблице, разделяя данные на группы (партиции). Она используется, когда нужно выполнить операции, такие как агрегирование, сортировка или вычисление рангов, но при этом эти операции должны применяться не ко всей таблице, а только к определенной группе строк, образующей партицию.

Базовый синтаксис выглядит вот так : 

```SQL
<window_function> OVER (PARTITION BY column1, column2 ORDER BY column3)
```

где : 
- `PARTITION BY`  — разделяет строки на группы (партиции). Функция будет вычисляться отдельно для каждой группы.
- `ORDER BY` — (опционально) указывает порядок строк внутри каждой партиции, если это необходимо для вычислений (например, для вычисления ранга или суммы по порядку).

Как работает PARTITION BY?
1. `Разбиение на партиции` : PARTITION BY делит результат запроса на группы, основываясь на значениях одного или нескольких столбцов.
2. `Оконная функция`  применяется к каждой из этих групп независимо друг от друга.
3. `Результаты`  для строк внутри одной группы могут различаться в зависимости от того, используется ли ORDER BY внутри оконной функции.


<h4>PARTITION BY с ROWS BETWEEN</h4>

Конструкция PARTITION BY с ROWS BETWEEN — это мощный инструмент в SQL, который используется для вычислений в рамках определённого окна (группы строк), с учётом как текущей строки, так и строк в пределах окна. В данном случае, конструкция используется для вычисления скользящего среднего.



Cписок основных оконных функций в PostgreSQL, которые можно использовать в запросах с PARTITION BY и ORDER BY для аналитики и агрегации данных:

1. `Агрегационные функции` 
- SUM() — Суммирует значения.
- AVG() — Вычисляет среднее значение.
- MIN() — Находит минимальное значение.
- MAX() — Находит максимальное значение.
- COUNT() — Подсчитывает количество строк.

2. `Функции для рангов`
- ROW_NUMBER() — Присваивает уникальный номер каждой строке в пределах группы, начиная с 1. Ранг зависит от порядка строк.
- RANK() — Присваивает ранг строкам, причем одинаковые строки получают одинаковый ранг, а следующая строка имеет пропущенный ранг. То есть, если две строки имеют ранг 1, следующая строка получит ранг 3 (пропуская 2).
- DENSE_RANK() — Присваивает ранг строкам, но без пропуска рангов. Если две строки имеют одинаковый ранг, то следующая строка получит следующий ранг, без пропуска.
- NTILE(n) — Делит строки на n равных частей и присваивает каждой строке номер группы (или “ведра”), в которую она попала.

3. `Функции для работы с порядком строк`
- LEAD() — Возвращает значение из следующей строки относительно текущей строки. Например, можно использовать для получения значения в следующей строке в определенном порядке.
- LAG() — Возвращает значение из предыдущей строки относительно текущей строки.
- FIRST_VALUE() — Возвращает первое значение из окна (первое значение по указанному порядку).
- LAST_VALUE() — Возвращает последнее значение из окна.
- NTH_VALUE() — Возвращает значение строки на заданной позиции в окне.


4. `Функции для вычислений на основе окна`
- CUME_DIST() — Вычисляет кумулятивное распределение: процент строк, которые меньше или равны текущей строке.
- PERCENT_RANK() — Вычисляет процентный ранг строки среди всех строк в окне. Это мера того, как далеко строка находится от первого значения в окне, выраженная в процентах.
- PERCENTILE_CONT() — Рассчитывает континуальное перцентильное значение для указанного окна. Обычно используется для вычисления медианы или других перцентилей.
- PERCENTILE_DISC() — Рассчитывает дискретное перцентильное значение для окна. Это возвращает конкретное значение, которое соответствует перцентилю в оконных данных.

  
5. `Функции для обработки строк`
- STRING_AGG() — Суммирует строки в одну строку, разделяя их заданным разделителем.


6. `Функции для статистики`
- VAR_POP() — Вычисляет дисперсию для популяции в пределах окна.
- VAR_SAMP() — Вычисляет дисперсию для выборки.
- STDDEV_POP() — Вычисляет стандартное отклонение для популяции.
- STDDEV_SAMP() — Вычисляет стандартное отклонение для выборки.





https://www.youtube.com/watch?v=yQ7qHZBY5xI
