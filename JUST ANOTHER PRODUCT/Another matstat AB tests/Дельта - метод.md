Когда речь идет про ratio - метрики , то здесь не все так просто. Проблема заключается в том, что знаменатель и числитель связаны друг с другом, из - за этого обычный t - test не справится так как мы не правильно там считаем дисперсию! Поэтому есть несколько способ, как избежать ошибку в подсчете дисперсии. Один из них это дельта - метод. 

Для начально вспомним, что формально метрики отношений можно представлять так : 

$$
	R = \frac{X_1 ....X_n}{Y_1 .... Y_n}
$$

Дельта-метод — это метод в математической статистике, используемый для приближённого вычисления распределения функции от случайной величины. Этот метод часто применяется для получения приближений распределений функций от случайных величин, когда точные распределения трудно найти или не известны.

Есть одномерный и двухмерный дельта - метод.

<h6>Одномерный дельта - метод</h6>

Одномерный дельта-метод — это метод приближения распределения функции от случайной величины, используя её первое и второе производные. Он часто применяется для нахождения приближённого распределения функции случайной величины, когда функция сложная, а распределение её точное найти сложно.

В общем виде это выглядит так : 

Пусть \( X_n \) — последовательность случайных величин, таких что:

$$
\sqrt{n}(X_n - \theta) \xrightarrow{d} N(0, \sigma^2)
$$

при $( n \to \infty$\), где $\theta$ — некоторое значение параметра, $N(0, \sigma^2)$  — нормальное распределение с математическим ожиданием 0 и дисперсией $\sigma^2$.

Если \( g \) — функция, которая имеет непрерывную производную в точке \(\theta\), то:

$$
Среднее:   \mathbb{E}[g(X_n)] \approx g(\theta) 
$$

$$
Дисперсия: \text{Var}[g(X_n)] \approx{\sigma^2 [g'(\theta)]^2}
$$


Рассмотрим простой пример `одномерного дельта-метода`.

Пусть X  — случайная величина, имеющая распределение $N(\mu, \sigma^2)$, то есть нормальное распределение с математическим ожиданием $mu$ и дисперсией $sigma^2$. Мы хотим найти приближенное распределение функции $Y = g(X)$, где функция  $g$ задана как $g(x) = \sqrt{x}$

Решение:

1 Найдём первую и вторую производные функции $g(x)$.
Функция $g(x) = \sqrt{x}$. Найдём её производную:
Первая производная: $g'(x) = \frac{1}{2\sqrt{x}}$.

2 Рассчитаем приближенную дисперсию \( Y \) с помощью дельта-метода.

По дельта-методу, если ( X ) имеет нормальное распределение $N(\mu, \sigma^2)$ и функция $g(x)$ дифференцируема, то приближённое распределение функции $g(X)$ можно найти следующим образом:

Приближённое математическое ожидание ( Y ):

$$
\mathbb{E}[Y] \approx g(\mu) = \sqrt{\mu}
$$

Приближённая дисперсия \( Y \):

$$
\text{Var}(Y) \approx \left(g'(\mu)\right)^2 \text{Var}(X) = \left(\frac{1}{2\sqrt{\mu}}\right)^2 \sigma^2 = \frac{\sigma^2}{4\mu}
$$

Теперь перейдем к `двухмерному дельта - методу КОНКРЕТНО ДЛЯ RATIO - МЕТРИКИ.` Именно его мы и будем использовать при подсчете доверительного интервала для ratio - метрики.

Наша дисперсия имеет следующий общий вид : 

$$
\text{Var}\left(\frac{Y}{X}\right) \approx \frac{\mathbb{E}(Y)^2}{\mathbb{E}(X)^4} \text{Var}(X) + \frac{\mathbb{E}(Y)^4}{\mathbb{E}(X)^2} \text{Var}(Y) - 2 \frac{\mathbb{E}(Y)^3}{\mathbb{E}(X)^3} \text{Cov}(X, Y)
$$

Таким образом , мы можем посчитать : 

$$
	R_{control} = \frac{X_1 ....X_n}{Y_1 .... Y_n}
$$

$$
	R_{test} = \frac{X_1 ....X_n}{Y_1 .... Y_n}
$$

Посчитать дисперсию для тестовой и контрольной выборки :  и затем просто посчитать t - value : 

$$
T_{value} = \frac{R_b - R_a}{\sqrt{V(R_a) + V(R))}}
$$

