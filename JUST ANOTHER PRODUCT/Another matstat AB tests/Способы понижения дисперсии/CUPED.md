Принцип CUPED (Controlled-experiment Using Pre-Existing Data) заключается в использовании предтестовых данных для уменьшения дисперсии и повышения точности оценок эффекта в AB-тестах. CUPED использует ковариаты (предварительно собранные данные) для коррекции текущих измерений, что позволяет улучшить обнаружение реальных изменений.

Идея. Дисперсия сильно зависит от шума. Если есть основания полагать, что шум - это постоянный фактор, то тогда он также влияет и на исторические данные. Если мы определим связь между данными историческими и данными в эксперименте, то мы сможем уменьшить дисперсию. 

Определим новую метрику : 

$$
{Y_{cuped}} = Y - {\theta}X
$$

Где : 
Y - это целевая метрика в эксперименте. 
X - это та же метрика только до эксперимента. 
${\theta}$ - некоторое число 

Посчитаем новую дисперсию для метрики ${Y_{cuped}}$ : 

$$
D({Y_{cuped}}) = D(Y) + {\theta}^2D(X) + 2COV(Y,X)
$$

Исходя из логики, нам нужно минимизировать эту дисперсию. То есть подобрать такую ${\theta}$ , которая сделает это выражение минимальным. 

Как выяснилось, дисперсия будет минимальной при : 

$$
\theta = COV(Y,X) / D(X)
$$







Как используем это в А/Б тестах : 

Т - это целевая метрика в тестовой группе , А - та же метрика, до теста (ковариарта)
С - целевая метрика  контрольной группе , B - та же метрика до теста (ковариарта)

Далее, для контрольной и тестовой выборки мы определяем метрики CUPED : 

${T_{cuped}} = T - {\theta}A$
${C_{cuped}} = C - {\theta}B$

Так как нас всегда интересует разница, то в таком случае мы считаем : 




