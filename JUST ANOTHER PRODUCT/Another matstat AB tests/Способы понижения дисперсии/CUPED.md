Принцип `CUPED (Controlled-experiment Using Pre-Existing Data)` заключается в использовании предтестовых данных для уменьшения дисперсии и повышения точности оценок эффекта в AB-тестах. CUPED использует ковариаты (предварительно собранные данные) для коррекции текущих измерений, что позволяет улучшить обнаружение реальных изменений.

<h6>Идея. </h6>

Дисперсия сильно зависит от шума. Если есть основания полагать, что шум - это постоянный фактор, то тогда он также влияет и на исторические данные. Если мы определим связь между данными историческими и данными в эксперименте, то мы сможем уменьшить дисперсию. 

Определим новую метрику : 

$$
{Y_{cuped}} = Y - {\theta}(X - \mathbb{E}(x))
$$

Где : 
`Y`  - это целевая метрика в эксперименте. 
`X`  - это та же метрика только до эксперимента. 
${\theta}$ - некоторое число 

Посчитаем новую дисперсию для метрики ${Y_{cuped}}$ : 

$$
D({Y_{cuped}}) = D(Y) + {\theta}^2D(X) + 2COV(Y,X)
$$

Исходя из логики, нам нужно минимизировать эту дисперсию. То есть подобрать такую ${\theta}$ , которая сделает это выражение минимальным. 

Как выяснилось, дисперсия будет минимальной при : 

$$
\theta = COV(Y,X) / VAR(X)
$$

<h6>Рассмотрим как это делается в АБ тестах. </h6>

Т - это целевая метрика в тестовой группе , А - та же метрика, до теста (ковариарта)
С - целевая метрика  контрольной группе , B - та же метрика до теста (ковариарта)

Далее, для контрольной и тестовой выборки мы определяем метрики CUPED : 

$${T_{cuped}} = T - {\theta}A$$
$${C_{cuped}} = C - {\theta}B$$

Так как нас всегда интересует разница, то в таком случае мы считаем : 

$${\delta_{cuped}} = {T_{cuped}} - {C_{cuped}}$$

Как мы видим выше , $\theta$ у них общая , по этому мы находим ее уже по такой формуле : 

${\theta} = (COV(T, A) + COV(C,B)) / VAR(A) + VAR(B)$

`Этот метод нельзя использовать для конверсий и метрик, связанных с процентилями.` 

Этот метод, очень хорошо снижает дисперсию!


<img width="535" alt="Screenshot 2024-08-08 at 17 11 30" src="https://github.com/user-attachments/assets/7366fe46-18ea-4250-8dd6-f25ab74cfe0c">


Так, оранжевое это распределение с `cuped` метрикой, а синие с обычной. Видим, что дисперсия оч сильно сократилась. 

А так как это понижает дисперсию, то мы можем уловить более малые изменения. Также необходимое количество `n` для выборки также снижается. 